import { useState } from "react";
import { allYearsData } from "@/data";
import { YearData } from "@/data/solicitudesTypes";
import { PieChart, Pie, Cell, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line } from "recharts";

const COLORS = {
  favorable: "hsl(142, 71%, 45%)",
  parcial: "hsl(38, 92%, 50%)",
  desfavorable: "hsl(0, 84%, 60%)",
  inadmision: "hsl(220, 9%, 46%)",
};

type ChartView = "bar" | "pie" | "line" | "percentage";

const Index = () => {
  const [selectedYear, setSelectedYear] = useState("2024");
  const [chartView, setChartView] = useState<ChartView>("bar");

  const yearData = allYearsData.find((d) => d.year === selectedYear);
  const stats = yearData?.stats;
  const total = stats ? stats.favorable + stats.parcial + stats.desfavorable + stats.inadmision : 0;

  const pieData = stats
    ? [
        { name: "Favorable", value: stats.favorable, color: COLORS.favorable },
        { name: "Parcial", value: stats.parcial, color: COLORS.parcial },
        { name: "Desfavorable", value: stats.desfavorable, color: COLORS.desfavorable },
        { name: "InadmisiÃ³n", value: stats.inadmision, color: COLORS.inadmision },
      ]
    : [];

  const lineData = allYearsData.map((d) => ({
    year: d.year,
    Favorable: d.stats.favorable,
    Parcial: d.stats.parcial,
    Desfavorable: d.stats.desfavorable,
    InadmisiÃ³n: d.stats.inadmision,
    Total: d.stats.favorable + d.stats.parcial + d.stats.desfavorable + d.stats.inadmision,
  }));

  const getResolucionColor = (sentido: string) => {
    const s = sentido.toLowerCase();
    if (s.includes("inadmisiÃ³n") || s.includes("inadmision")) return "bg-inadmision text-inadmision-foreground";
    if (s.includes("desfavorable")) return "bg-desfavorable text-desfavorable-foreground";
    if (s.includes("parcial")) return "bg-parcial text-parcial-foreground";
    if (s.includes("favorable")) return "bg-favorable text-favorable-foreground";
    return "bg-muted text-muted-foreground";
  };

  return (
    <div className="min-h-screen bg-background p-4 md:p-6">
      <div className="max-w-[1400px] mx-auto bg-card rounded-lg shadow-lg overflow-hidden">
        {/* Header */}
        <div className="bg-gradient-to-r from-primary to-[hsl(var(--ucm-red-dark))] p-6 md:p-8 text-center">
          <h1 className="text-2xl md:text-3xl font-semibold text-primary-foreground mb-2">
            ðŸ“‹ Registro de Solicitudes de Transparencia
          </h1>
          <p className="text-primary-foreground/90 text-sm md:text-base">
            Universidad Complutense de Madrid (2020-2025)
          </p>
        </div>

        {/* Controls */}
        <div className="p-4 md:p-6 bg-muted/50 border-b border-border">
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-semibold uppercase tracking-wide text-foreground/70 mb-2">AÃ±o</label>
              <select
                value={selectedYear}
                onChange={(e) => setSelectedYear(e.target.value)}
                className="w-full p-3 border-2 border-border rounded-lg bg-card text-foreground cursor-pointer transition-all hover:border-primary focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
              >
                {allYearsData.map((d) => (
                  <option key={d.year} value={d.year}>{d.year}</option>
                ))}
              </select>
            </div>
            <div>
              <label className="block text-sm font-semibold uppercase tracking-wide text-foreground/70 mb-2">Vista de GrÃ¡fico</label>
              <div className="flex gap-2 flex-wrap">
                {([["bar", "ðŸ“Š Barras"], ["pie", "ðŸ¥§ Circular"], ["line", "ðŸ“ˆ EvoluciÃ³n"], ["percentage", "ðŸ“Š Porcentajes"]] as [ChartView, string][]).map(([view, label]) => (
                  <button
                    key={view}
                    onClick={() => setChartView(view)}
                    className={`flex-1 min-w-[120px] px-3 py-2 border-2 rounded-lg font-semibold text-sm text-center transition-all cursor-pointer ${
                      chartView === view
                        ? "border-primary bg-primary/5 text-primary"
                        : "border-border bg-card text-foreground hover:border-primary hover:bg-primary/5"
                    }`}
                  >
                    {label}
                  </button>
                ))}
              </div>
            </div>
          </div>
        </div>

        {/* Chart */}
        <div className="p-4 md:p-6">
          <div className="h-[300px] md:h-[350px]">
            <ResponsiveContainer width="100%" height="100%">
              {chartView === "pie" ? (
                <PieChart>
                  <Pie data={pieData} cx="50%" cy="50%" outerRadius={120} dataKey="value" label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}>
                    {pieData.map((entry, i) => (<Cell key={i} fill={entry.color} />))}
                  </Pie>
                  <Tooltip />
                </PieChart>
              ) : chartView === "line" ? (
                <LineChart data={lineData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="year" />
                  <YAxis />
                  <Tooltip />
                  <Legend />
                  <Line type="monotone" dataKey="Favorable" stroke={COLORS.favorable} strokeWidth={2} />
                  <Line type="monotone" dataKey="Parcial" stroke={COLORS.parcial} strokeWidth={2} />
                  <Line type="monotone" dataKey="Desfavorable" stroke={COLORS.desfavorable} strokeWidth={2} />
                  <Line type="monotone" dataKey="InadmisiÃ³n" stroke={COLORS.inadmision} strokeWidth={2} />
                </LineChart>
              ) : chartView === "percentage" ? (
                <BarChart data={pieData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis tickFormatter={(v) => `${total ? ((v / total) * 100).toFixed(0) : 0}%`} />
                  <Tooltip formatter={(v: number) => [`${total ? ((v / total) * 100).toFixed(1) : 0}%`, "Porcentaje"]} />
                  <Bar dataKey="value">
                    {pieData.map((entry, i) => (<Cell key={i} fill={entry.color} />))}
                  </Bar>
                </BarChart>
              ) : (
                <BarChart data={pieData}>
                  <CartesianGrid strokeDasharray="3 3" />
                  <XAxis dataKey="name" />
                  <YAxis />
                  <Tooltip />
                  <Bar dataKey="value">
                    {pieData.map((entry, i) => (<Cell key={i} fill={entry.color} />))}
                  </Bar>
                </BarChart>
              )}
            </ResponsiveContainer>
          </div>
        </div>

        {/* Stats Grid */}
        {stats && (
          <div className="grid grid-cols-2 md:grid-cols-5 gap-3 px-4 md:px-6 pb-4">
            {[
              { label: "Favorable", value: stats.favorable, pct: total ? ((stats.favorable / total) * 100).toFixed(1) : "0", cls: "bg-favorable text-favorable-foreground" },
              { label: "Parcial", value: stats.parcial, pct: total ? ((stats.parcial / total) * 100).toFixed(1) : "0", cls: "bg-parcial text-parcial-foreground" },
              { label: "Desfavorable", value: stats.desfavorable, pct: total ? ((stats.desfavorable / total) * 100).toFixed(1) : "0", cls: "bg-desfavorable text-desfavorable-foreground" },
              { label: "InadmisiÃ³n", value: stats.inadmision, pct: total ? ((stats.inadmision / total) * 100).toFixed(1) : "0", cls: "bg-inadmision text-inadmision-foreground" },
              { label: "Total", value: total, pct: "100", cls: "bg-primary text-primary-foreground" },
            ].map((s) => (
              <div key={s.label} className={`${s.cls} rounded-lg p-4 text-center shadow`}>
                <div className="text-xs uppercase tracking-wider opacity-90 mb-1">{s.label}</div>
                <div className="text-2xl font-bold">{s.value}</div>
                <div className="text-xs opacity-80">{s.pct}%</div>
              </div>
            ))}
          </div>
        )}

        {/* Table */}
        <div className="p-4 md:p-6">
          <h2 className="text-lg font-semibold text-foreground mb-4">
            ðŸ“„ Detalle Completo de Solicitudes {selectedYear}
          </h2>
          <div className="overflow-x-auto border border-border rounded-lg">
            <table className="w-full text-xs md:text-sm">
              <thead>
                <tr className="bg-primary text-primary-foreground">
                  <th className="p-2 text-left font-semibold">NÂº Expte.</th>
                  <th className="p-2 text-left font-semibold">Fecha Entrada</th>
                  <th className="p-2 text-left font-semibold">Solicitante</th>
                  <th className="p-2 text-left font-semibold min-w-[200px]">Resumen</th>
                  <th className="p-2 text-left font-semibold">Forma Acceso</th>
                  <th className="p-2 text-left font-semibold">VÃ­a Contacto</th>
                  <th className="p-2 text-left font-semibold">Tiempo ResoluciÃ³n</th>
                  <th className="p-2 text-left font-semibold">Sentido ResoluciÃ³n</th>
                  <th className="p-2 text-left font-semibold">Motivo DenegaciÃ³n</th>
                  <th className="p-2 text-left font-semibold">ReclamaciÃ³n CT</th>
                </tr>
              </thead>
              <tbody>
                {yearData?.solicitudes.map((sol, i) => (
                  <tr key={i} className={`border-t border-border ${i % 2 === 0 ? "bg-card" : "bg-muted/30"} hover:bg-accent/50 transition-colors`}>
                    <td className="p-2">
                      {sol.expedienteLink ? (
                        <a href={sol.expedienteLink} target="_blank" rel="noopener noreferrer" className="text-primary underline hover:text-primary/80">{sol.expediente}</a>
                      ) : sol.expediente}
                    </td>
                    <td className="p-2 whitespace-nowrap">{sol.fechaEntrada}</td>
                    <td className="p-2">{sol.solicitante}</td>
                    <td className="p-2">{sol.resumen}</td>
                    <td className="p-2">{sol.formaAcceso}</td>
                    <td className="p-2 break-all">{sol.viaContacto}</td>
                    <td className="p-2">{sol.tiempoResolucion}</td>
                    <td className="p-2">
                      {sol.sentidoResolucion && (
                        <span className={`inline-block px-2 py-1 rounded text-xs font-semibold whitespace-nowrap ${getResolucionColor(sol.sentidoResolucion)}`}>
                          {sol.sentidoResolucion}
                        </span>
                      )}
                    </td>
                    <td className="p-2">{sol.motivoDenegacion === "***" ? "â€”" : sol.motivoDenegacion}</td>
                    <td className="p-2">
                      {sol.reclamacionCTLink ? (
                        <a href={sol.reclamacionCTLink} target="_blank" rel="noopener noreferrer" className="text-primary underline hover:text-primary/80 font-semibold">{sol.reclamacionCT}</a>
                      ) : (
                        <span className={sol.reclamacionCT === "NO" ? "text-muted-foreground" : "font-semibold"}>{sol.reclamacionCT}</span>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {/* Footer */}
        <div className="bg-muted/50 border-t border-border p-4 text-center text-sm text-muted-foreground">
          Universidad Complutense de Madrid | Portal de Transparencia
        </div>
      </div>
    </div>
  );
};

export default Index;
